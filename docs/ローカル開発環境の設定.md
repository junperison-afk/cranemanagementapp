# ローカル開発環境の設定

## 概要

ローカル開発環境でアプリケーションを動作させるための設定手順を説明します。

## 環境変数の設定

### 1. `.env.local` ファイルの作成

プロジェクトルートに `.env.local` ファイルを作成します（`.env.local` はGitにコミットされません）。

```env
DATABASE_URL=postgresql://postgres:[PASSWORD]@db.nypyvzqfmessxboiwfka.supabase.co:5432/postgres
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=[ランダムな32文字以上の文字列]
```

**注意事項:**

- **`DATABASE_URL`**: ローカル開発環境では、**直接接続用**（ポート**5432**）を使用してください
  - 接続プーリング用（ポート6543）はサーバーレス環境用で、ローカル開発では不要です
  - 本番環境とは**同じデータベース**を参照する場合と、**別のデータベース**を参照する場合があります

- **`NEXTAUTH_URL`**: ローカル開発環境では `http://localhost:3000` を使用してください

- **`NEXTAUTH_SECRET`**: ローカル開発用のシークレットを生成してください
  ```bash
  # ターミナルで実行
  openssl rand -base64 32
  ```

### 2. 本番環境と同じデータベースを使用する場合（推奨）

本番環境と同じデータベースを使用する場合、`DATABASE_URL` を設定します：

**重要:** 本番環境では接続プーリング用（ポート6543）を使用していますが、ローカル環境では**直接接続用**（ポート5432）を使用してください。

**本番環境のDATABASE_URL（Vercelで設定されている値）:**
```
postgresql://postgres.nypyvzqfmessxboiwfka:[PASSWORD]@aws-1-ap-south-1.pooler.supabase.com:6543/postgres?pgbouncer=true&connect_timeout=15&pool_timeout=15
```

**ローカル環境用のDATABASE_URL（`.env.local` に設定する値）:**

**オプション1: 直接接続用（ポート5432）を試す**
```
DATABASE_URL=postgresql://postgres:[PASSWORD]@db.nypyvzqfmessxboiwfka.supabase.co:5432/postgres
```

**オプション2: 接続プーリング用（ポート6543）を使用（推奨）**
直接接続ができない場合、接続プーリング用のURLを使用することも可能です：
```
DATABASE_URL=postgresql://postgres.nypyvzqfmessxboiwfka:[PASSWORD]@aws-1-ap-south-1.pooler.supabase.com:6543/postgres?pgbouncer=true&connect_timeout=15&pool_timeout=15
```

**設定手順:**
1. 本番環境と同じデータベースパスワードを使用
2. **オプション1（直接接続）**:
   - ホスト名: `db.nypyvzqfmessxboiwfka.supabase.co`
   - ポート: `5432`
   - 接続パラメータ: 不要
3. **オプション2（接続プーリング）**:
   - ホスト名: `aws-1-ap-south-1.pooler.supabase.com`（接続プーリング用）
   - ポート: `6543`
   - 接続パラメータ: `?pgbouncer=true&connect_timeout=15&pool_timeout=15`

**注意:** Supabaseの設定によっては、直接接続（ポート5432）がブロックされている場合があります。その場合は接続プーリング用（ポート6543）を使用してください。

**メリット:**
- 本番環境と同じデータを参照できる
- データの同期が不要
- 既存のユーザーでログインできる（追加のユーザー作成が不要）

**注意事項:**
- 本番データを誤って変更するリスクがあるため、**注意深く操作**してください
- 本番環境に負荷をかける可能性があるため、開発時は軽量な操作を推奨
- 重要なデータを変更する前に、必ずバックアップを取ることを推奨

### 3. 別のデータベースを使用する場合（推奨）

開発用のデータベースを別途用意する場合：

```env
DATABASE_URL=postgresql://postgres:[DEV_PASSWORD]@db.[DEV_PROJECT].supabase.co:5432/postgres
```

**メリット:**
- 本番データを誤って変更するリスクがない
- 自由にデータを操作できる
- 本番環境に負荷をかけない

**デメリット:**
- 別のデータベースを用意する必要がある
- データの同期が必要な場合がある

## ローカル環境でのテストユーザー作成

### 方法1: スクリプトを使用（推奨）

1. **環境変数を設定**
   ```bash
   # .env.local に DATABASE_URL が設定されていることを確認
   ```

2. **テストユーザーを作成**
   ```bash
   npm run create-test-user
   ```

   これで以下のユーザーが作成されます：
   - Email: `admin@example.com`
   - Password: `password123`
   - Role: `ADMIN`

### 方法2: SQLで直接作成

SupabaseのSQL Editorで以下を実行：

```sql
-- パスワードは password123 のハッシュ
INSERT INTO users (id, email, name, password, role, "createdAt", "updatedAt")
VALUES (
  gen_random_uuid()::text,
  'admin@example.com',
  '管理者',
  '$2b$10$bvUk4VPG5KBijAbdyU2tm.PthOnziq6qVhzIi9VthrP5sndA5BRmi',
  'ADMIN',
  NOW(),
  NOW()
)
ON CONFLICT (email) DO UPDATE
SET 
  name = EXCLUDED.name,
  password = EXCLUDED.password,
  role = EXCLUDED.role,
  "updatedAt" = NOW();
```

## ローカル環境での動作確認

### 1. 開発サーバーの起動

```bash
npm run dev
```

### 2. ブラウザでアクセス

- `http://localhost:3000` にアクセス
- ログインページが表示されることを確認

### 3. ログイン確認

- Email: `admin@example.com`
- Password: `password123`
- ログインが成功することを確認

### 4. デバッグログの確認

ローカル環境では、認証処理のデバッグログがコンソールに表示されます：

```
[Auth] User found: admin@example.com, ID: ...
[Auth] Authentication successful for: admin@example.com
```

## トラブルシューティング

### 問題1: ログインできない

**原因:**
- `.env.local` ファイルが存在しない、または `DATABASE_URL` が設定されていない
- ローカル環境のデータベースにユーザーが存在しない
- パスワードが間違っている

**解決方法:**
1. `.env.local` ファイルが存在し、`DATABASE_URL` が正しく設定されているか確認
2. ローカル環境のデータベースにユーザーが存在するか確認
   ```bash
   npm run create-test-user
   ```
3. データベース接続が正常か確認
   ```bash
   npx prisma studio
   ```

### 問題2: データベース接続エラー

**原因:**
- `DATABASE_URL` が正しく設定されていない
- データベースへの接続が許可されていない（IPアドレス制限など）

**解決方法:**
1. `.env.local` の `DATABASE_URL` が正しいか確認
2. Supabaseのファイアウォール設定で、ローカルIPアドレスを許可
3. 直接接続用（ポート5432）のURLを使用しているか確認

### 問題3: 本番環境とローカル環境でデータが異なる

**原因:**
- ローカル環境と本番環境で異なるデータベースを参照している

**解決方法:**
1. `.env.local` の `DATABASE_URL` を確認
2. 本番環境と同じデータベースを使用する場合は、同じ `DATABASE_URL` を設定
3. 別のデータベースを使用する場合は、開発用データベースにテストユーザーを作成

## 環境変数の管理

### `.env.local` vs `.env`

- **`.env.local`**: ローカル開発環境専用（Gitにコミットされない）
- **`.env`**: 共通の環境変数（Gitにコミットされる場合がある）

**推奨:**
- 機密情報（パスワード、APIキーなど）は `.env.local` に設定
- `.env.local` は `.gitignore` に含まれていることを確認

### `.gitignore` の確認

`.gitignore` に以下が含まれていることを確認：

```
.env.local
.env*.local
```

## 参考リンク

- [Next.js公式ドキュメント: 環境変数](https://nextjs.org/docs/app/building-your-application/configuring/environment-variables)
- [Prisma公式ドキュメント: 環境変数](https://www.prisma.io/docs/concepts/components/prisma-client/working-with-prismaclient/connection-issues)

