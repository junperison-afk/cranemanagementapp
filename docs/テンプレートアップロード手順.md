# テンプレートアップロード手順

## 概要

作成したプレースホルダー入りのテンプレート（.docx または .xlsx）をシステムにアップロードする方法を説明します。

## アップロード方法

### 方法1: APIエンドポイントに直接リクエストを送信（推奨）

#### 必要な情報

- **APIエンドポイント**: `/api/document-templates`
- **メソッド**: POST
- **認証**: 編集者以上の権限が必要
- **Content-Type**: `multipart/form-data`

#### リクエストパラメータ

| パラメータ名 | 型 | 必須 | 説明 |
|------------|---|------|------|
| `file` | File | ✅ | テンプレートファイル（.docx または .xlsx） |
| `templateType` | String | ✅ | テンプレートタイプ（`QUOTE`, `CONTRACT`, `REPORT`） |
| `name` | String | ✅ | テンプレート名 |
| `description` | String | ❌ | 説明（オプショナル） |
| `isDefault` | String | ❌ | デフォルトテンプレートにするか（`"true"` または `"false"`） |

#### 使用例

**cURLコマンド：**

```bash
curl -X POST http://localhost:3001/api/document-templates \
  -H "Cookie: next-auth.session-token=YOUR_SESSION_TOKEN" \
  -F "file=@見積書テンプレート.xlsx" \
  -F "templateType=QUOTE" \
  -F "name=見積書テンプレート_標準版" \
  -F "description=見積書テンプレートの標準版です" \
  -F "isDefault=true"
```

**JavaScript（ブラウザのコンソールから実行）：**

```javascript
const formData = new FormData();
formData.append('file', fileInput.files[0]); // fileInputは<input type="file">要素
formData.append('templateType', 'QUOTE');
formData.append('name', '見積書テンプレート_標準版');
formData.append('description', '見積書テンプレートの標準版です');
formData.append('isDefault', 'true');

const response = await fetch('/api/document-templates', {
  method: 'POST',
  body: formData,
});

const result = await response.json();
console.log('アップロード結果:', result);
```

**PowerShell（Windows）:**

```powershell
$filePath = "C:\path\to\見積書テンプレート.xlsx"
$boundary = [System.Guid]::NewGuid().ToString()
$fileBytes = [System.IO.File]::ReadAllBytes($filePath)
$fileName = [System.IO.Path]::GetFileName($filePath)

$bodyLines = @()
$bodyLines += "--$boundary"
$bodyLines += "Content-Disposition: form-data; name=`"file`"; filename=`"$fileName`""
$bodyLines += "Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
$bodyLines += ""
$bodyLines += [System.Text.Encoding]::GetEncoding("iso-8859-1").GetString($fileBytes)
$bodyLines += "--$boundary"
$bodyLines += "Content-Disposition: form-data; name=`"templateType`""
$bodyLines += ""
$bodyLines += "QUOTE"
$bodyLines += "--$boundary"
$bodyLines += "Content-Disposition: form-data; name=`"name`""
$bodyLines += ""
$bodyLines += "見積書テンプレート_標準版"
$bodyLines += "--$boundary--"

$body = $bodyLines -join "`r`n"
$bytes = [System.Text.Encoding]::UTF8.GetBytes($body)

Invoke-RestMethod -Uri "http://localhost:3001/api/document-templates" `
  -Method Post `
  -ContentType "multipart/form-data; boundary=$boundary" `
  -Body $bytes `
  -Headers @{"Cookie"="next-auth.session-token=YOUR_SESSION_TOKEN"}
```

### 方法2: テンプレートアップロード画面を使用（今後実装予定）

テンプレートアップロード専用の画面を実装する予定です。

### 方法3: ブラウザの開発者ツールを使用

1. ブラウザの開発者ツール（F12）を開く
2. コンソールタブを選択
3. 以下のコードを実行：

```javascript
// ファイル選択ダイアログを表示（実際にはファイルパスを指定する必要があります）
const fileInput = document.createElement('input');
fileInput.type = 'file';
fileInput.accept = '.docx,.xlsx';
fileInput.onchange = async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const formData = new FormData();
  formData.append('file', file);
  formData.append('templateType', 'QUOTE');
  formData.append('name', file.name.replace(/\.[^/.]+$/, ''));
  formData.append('description', 'アップロードしたテンプレート');
  formData.append('isDefault', 'false');
  
  try {
    const response = await fetch('/api/document-templates', {
      method: 'POST',
      body: formData,
    });
    
    if (response.ok) {
      const result = await response.json();
      console.log('✅ アップロード成功:', result);
      alert('テンプレートのアップロードに成功しました');
    } else {
      const error = await response.json();
      console.error('❌ アップロード失敗:', error);
      alert('テンプレートのアップロードに失敗しました: ' + error.error);
    }
  } catch (error) {
    console.error('❌ エラー:', error);
    alert('エラーが発生しました: ' + error.message);
  }
};

fileInput.click();
```

## 注意事項

### ファイルサイズ制限

- 最大ファイルサイズ: **5MB**
- それ以上のファイルをアップロードするとエラーになります

### 対応ファイル形式

- `.docx` (Word)
- `.xlsx` (Excel 2007以降)
- `.doc` や `.xls` などの旧形式はサポートされていません

### テンプレートタイプ

- `QUOTE` - 見積書テンプレート
- `CONTRACT` - 契約書テンプレート
- `REPORT` - 報告書テンプレート

### デフォルトテンプレート

- `isDefault` を `"true"` に設定すると、同じタイプの既存のデフォルトテンプレートは自動的に無効化されます
- デフォルトテンプレートは、すべてのユーザーが使用できます

### ユーザー専用テンプレート

- `isDefault` を `"false"` または省略すると、アップロードしたユーザー専用のテンプレートとして保存されます
- 他のユーザーはこのテンプレートを使用できません

## アップロード後の確認

テンプレートが正しくアップロードされたか確認するには：

1. 見積詳細画面を開く
2. 「見積書作成」ボタンをクリック
3. アップロードしたテンプレートが一覧に表示されることを確認

## トラブルシューティング

### エラー: "認証が必要です"

- ログイン状態を確認してください
- セッションが切れている場合は、再度ログインしてください

### エラー: "この操作を実行する権限がありません"

- 編集者以上の権限が必要です
- 閲覧者ロールではテンプレートをアップロードできません

### エラー: "サポートされていないファイル形式です"

- `.docx` または `.xlsx` 形式のファイルをアップロードしてください
- ファイルが破損していないか確認してください

### エラー: "ファイルサイズが大きすぎます"

- ファイルサイズが5MB以下であることを確認してください
- ファイルを圧縮するか、不要な要素を削除してください

### プレースホルダーが置換されない

- プレースホルダーの形式を確認してください（`{{変数名}}`）
- テンプレートプレースホルダー定義書を参照して、正しい変数名を使用しているか確認してください

