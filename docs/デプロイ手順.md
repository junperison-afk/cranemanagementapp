# デプロイ手順

## Xサーバーへのデプロイ方法

### 重要な注意事項

**Xサーバーは通常、Node.jsが使えない共有ホスティングサービスです。**

このアプリケーションは以下の機能を使用しているため、**Node.js実行環境が必須**です：
- サーバーサイドレンダリング（SSR）
- APIルート（`/api/*`）
- データベース接続（Supabase PostgreSQL）
- NextAuth.js（認証機能）

### デプロイ方法の選択

#### ⚠️ 静的エクスポートは使用できません

静的エクスポート（`output: 'export'`）では、APIルートやサーバーサイド機能が動作しないため、このアプリケーションは動作しません。

#### 方法1: XサーバーでNode.jsが使える場合（要確認）

Xサーバーの一部のプランではNode.jsが使える場合があります。サーバーパネルで確認してください。

`/crane-mitsumori.com/public_html/manage` にデプロイする場合：

1. **ローカルでビルド**
```bash
npm run build
```

2. **必要なファイルをサーバーにアップロード**
以下のファイル・フォルダを `/crane-mitsumori.com/public_html/manage` にアップロード：
- `.next/` フォルダ（ビルド成果物）
- `public/` フォルダ
- `node_modules/` フォルダ（またはサーバーで `npm install --production` を実行）
- `package.json`
- `package-lock.json`
- `.env.local`（環境変数ファイル、セキュアに管理）

3. **サーバーで依存関係をインストール**（必要に応じて）
```bash
cd /crane-mitsumori.com/public_html/manage
npm install --production
```

4. **Prismaクライアントを生成**
```bash
npx prisma generate
```

5. **アプリケーションを起動**
```bash
npm start
```

6. **プロセス管理ツールを使用**（推奨）
- PM2を使用してアプリケーションを常時起動
```bash
npm install -g pm2
pm2 start npm --name "crane-management" -- start
pm2 save
pm2 startup
```

#### 方法2: 別のサーバーを使用（推奨）

XサーバーでNode.jsが使えない場合、以下の選択肢があります：

##### 2-1. VPSサーバーを借りる
- ConoHa VPS、さくらのVPS、AWS EC2など
- Node.js環境を構築可能
- `/crane-mitsumori.com/public_html/manage` の代わりに、VPSサーバーにデプロイ
- サブドメイン（`manage.crane-mitsumori.com`）をVPSサーバーに設定

##### 2-2. VercelなどのNext.js専用ホスティング（最も簡単・推奨）

1. **Vercelアカウントを作成**
   - https://vercel.com でアカウント作成（無料プランあり）

2. **GitHubリポジトリと連携**
   - GitHubにリポジトリをプッシュ
   - VercelでGitHubリポジトリをインポート

3. **環境変数を設定**
   - Vercelのダッシュボードで環境変数を設定
   - `DATABASE_URL`, `NEXTAUTH_URL`, `NEXTAUTH_SECRET`

4. **自動デプロイ**
   - GitHubにプッシュすると自動でデプロイ
   - デフォルトで `https://[プロジェクト名].vercel.app` でアクセス可能

5. **カスタムドメインの設定**
   - Vercelのダッシュボードで `manage.crane-mitsumori.com` を設定
   - XサーバーのDNS設定で、`manage.crane-mitsumori.com` をVercelのIPアドレスに設定

**メリット:**
- Next.jsに最適化されている
- 自動デプロイ
- SSL証明書が自動で設定される
- 無料プランでも十分な機能

#### 方法3: Xサーバーのサブディレクトリに別サーバーを設定

Xサーバーのメインドメイン（`crane-mitsumori.com`）はXサーバーで運用し、サブドメイン（`manage.crane-mitsumori.com`）だけ別のサーバー（VercelやVPS）に設定する方法もあります。

### 環境変数の設定

本番環境で以下の環境変数を設定する必要があります：

```env
DATABASE_URL=postgresql://postgres:[PASSWORD]@db.nypyvzqfmessxboiwfka.supabase.co:5432/postgres
NEXTAUTH_URL=https://manage.crane-mitsumori.com
NEXTAUTH_SECRET=[ランダムな文字列]
```

### 注意事項

1. **セキュリティ**
   - `.env.local` は絶対にGitにコミットしない
   - 本番環境の環境変数は安全に管理する

2. **データベース**
   - 本番環境用のデータベース接続情報を使用
   - マイグレーションを実行してスキーマを適用

3. **パフォーマンス**
   - プロセス管理ツール（PM2など）を使用してアプリケーションを常時起動
   - 必要に応じてリバースプロキシ（Nginxなど）を設定

4. **ドメイン設定**
   - `manage.crane-mitsumori.com` が `/crane-mitsumori.com/public_html/manage` を指すように設定
   - SSL証明書の設定（Let's Encryptなど）

### デプロイ後の確認事項

- [ ] アプリケーションが正常に起動している
- [ ] ログイン機能が動作する
- [ ] データベース接続が正常
- [ ] 各画面が正常に表示される
- [ ] APIルートが正常に動作する
- [ ] 環境変数が正しく設定されている

