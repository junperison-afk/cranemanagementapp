# テンプレートプレースホルダー定義書

## 概要

見積書テンプレート（Word/Excel）に使用できるプレースホルダーと、営業案件の項目との対応関係を定義します。

## プレースホルダー形式

### Wordテンプレート（.docx）の場合

`docxtemplater`を使用するため、以下の形式でプレースホルダーを設定します：

```
{{変数名}}
```

**例：**
- `{{companyName}}` → 取引先名
- `{{amount}}` → 金額

### Excelテンプレート（.xlsx）の場合

`exceljs`を使用するため、以下の形式でプレースホルダーを設定します：

```
{{変数名}}
```

**重要：** Excelのセルに直接 `{{変数名}}` と入力してください。
セルの値として設定されていれば、自動的に置換されます。

**例：**
- セル A1 に `{{companyName}}` と入力 → 取引先名に置換
- セル B2 に `{{amount}}` と入力 → 金額に置換

## 利用可能なプレースホルダー一覧

### 取引先情報

| プレースホルダー | 営業案件の項目 | 説明 | データ型 | 例 |
|----------------|-------------|------|---------|-----|
| `{{companyName}}` | `company.name` | 取引先会社名 | 文字列 | "株式会社○○工業" |
| `{{companyPostalCode}}` | `company.postalCode` | 郵便番号 | 文字列 | "123-4567" |
| `{{companyAddress}}` | `company.address` | 住所 | 文字列 | "東京都○○区..." |
| `{{companyPhone}}` | `company.phone` | 電話番号 | 文字列 | "03-1234-5678" |
| `{{companyEmail}}` | `company.email` | メールアドレス | 文字列 | "info@example.com" |

### 営業案件情報

| プレースホルダー | 営業案件の項目 | 説明 | データ型 | 例 |
|----------------|-------------|------|---------|-----|
| `{{opportunityTitle}}` | `title` | 案件タイトル | 文字列 | "天井クレーン点検案件" |
| `{{status}}` | `status` | ステータス（英語コード） | 文字列 | "ESTIMATING" |
| `{{statusLabel}}` | `status` | ステータス（日本語） | 文字列 | "見積中" |
| `{{estimatedAmount}}` | `estimatedAmount` | 想定金額（数値のみ、3桁区切りなし） | 数値文字列 | "1000000" |
| `{{estimatedAmountFormatted}}` | `estimatedAmount` | 想定金額（¥記号付き、3桁区切り） | 文字列 | "¥1,000,000" |
| `{{craneCount}}` | `craneCount` | クレーン台数 | 数値文字列 | "5" |
| `{{craneInfo}}` | `craneInfo` | クレーン情報（型式・概要） | 文字列 | "5t天井クレーン..." |
| `{{notes}}` | `notes` | 備考 | 文字列 | "全クレーン設備の包括的点検" |
| `{{occurredAt}}` | `occurredAt` | 発生日（YYYY/MM/DD形式） | 文字列 | "2024/11/17" |
| `{{quoteCount}}` | `_count.quotes` | 見積数 | 数値文字列 | "3" |

### 見積情報

| プレースホルダー | 見積データの項目 | 説明 | データ型 | 例 |
|----------------|---------------|------|---------|-----|
| `{{quoteNumber}}` | `quoteNumber` | 見積番号（Q-YYYYMM-XXXX形式） | 文字列 | "Q-202411-0001" |
| `{{quoteAmount}}` | `amount` | 見積金額（数値のみ、3桁区切りなし、整数） | 数値文字列 | "37000" |
| `{{quoteAmountFormatted}}` | `amount` | 見積金額（¥記号付き、3桁区切り、整数） | 文字列 | "¥37,000" |
| `{{quoteStatus}}` | `status` | 見積ステータス（英語コード） | 文字列 | "DRAFT" |
| `{{quoteStatusLabel}}` | `status` | 見積ステータス（日本語） | 文字列 | "下書き" |
| `{{quoteConditions}}` | `conditions` | 条件 | 文字列 | "納期: 2週間..." |
| `{{quoteValidUntil}}` | `validUntil` | 有効期限（YYYY/MM/DD形式） | 文字列 | "2024/12/31" |
| `{{quoteNotes}}` | `notes` | 備考 | 文字列 | "追加の点検項目について" |
| `{{quoteCreatedAt}}` | `createdAt` | 作成日（YYYY/MM/DD形式） | 文字列 | "2024/11/17" |
| `{{quoteCreatedAtDateTime}}` | `createdAt` | 作成日時（YYYY/MM/DD HH:MM形式） | 文字列 | "2024/11/17 10:30" |
| `{{quoteUpdatedAt}}` | `updatedAt` | 更新日（YYYY/MM/DD形式） | 文字列 | "2024/11/17" |
| `{{quoteUpdatedAtDateTime}}` | `updatedAt` | 更新日時（YYYY/MM/DD HH:MM形式） | 文字列 | "2024/11/17 14:20" |

**注意：** 見積情報は、見積書生成時に選択された見積データから取得されます。

### 見積明細

見積明細は複数行になるため、Excelテンプレートでは以下の方法で表示できます。

#### 方法1: 明細行をループで表示（推奨）

`docxtemplater`や`exceljs`のループ機能を使用する場合、以下の形式でプレースホルダーを設定します：

**Wordテンプレート（.docx）の場合：**
```
{{#items}}
明細番号: {{itemNumber}}
明細内容: {{description}}
数量: {{quantity}}
単価: {{unitPriceFormatted}}
金額: {{amountFormatted}}
備考: {{notes}}
{{/items}}
```

**Excelテンプレート（.xlsx）の場合：**
現在の実装では、ループ機能はサポートされていません。方法2を使用してください。

#### 方法2: 固定行数で明細を表示

Excelテンプレートで固定行数（例: 10行）を用意し、各明細を個別のプレースホルダーで指定します：

**明細1行目：**
| プレースホルダー | 見積明細の項目 | 説明 | データ型 | 例 |
|----------------|-------------|------|---------|-----|
| `{{item1Number}}` | `items[0].itemNumber` | 明細番号（1行目） | 数値文字列 | "1" |
| `{{item1Description}}` | `items[0].description` | 明細内容（1行目） | 文字列 | "(1) 定期自主検査" |
| `{{item1Quantity}}` | `items[0].quantity` | 数量（1行目、整数） | 数値文字列 | "1" |
| `{{item1UnitPrice}}` | `items[0].unitPrice` | 単価（1行目、整数、3桁区切りなし） | 数値文字列 | "30000" |
| `{{item1UnitPriceFormatted}}` | `items[0].unitPrice` | 単価（1行目、¥記号付き、3桁区切り） | 文字列 | "¥30,000" |
| `{{item1Amount}}` | `items[0].amount` | 金額（1行目、整数、3桁区切りなし） | 数値文字列 | "30000" |
| `{{item1AmountFormatted}}` | `items[0].amount` | 金額（1行目、¥記号付き、3桁区切り） | 文字列 | "¥30,000" |
| `{{item1Notes}}` | `items[0].notes` | 備考（1行目） | 文字列 | "" |

**明細2行目以降：**
同様に、`item2`, `item3`, `item4`, ... `item10` のように番号を変更して使用します。

**例：**
```
明細番号: item2Number, 明細内容: item2Description, 数量: item2Quantity, ...
```

#### 方法3: 明細の合計情報

| プレースホルダー | 説明 | データ型 | 例 |
|----------------|------|---------|-----|
| `{{itemsCount}}` | 明細行数 | 数値文字列 | "3" |
| `{{totalAmount}}` | 合計金額（数値のみ、3桁区切りなし、整数） | 数値文字列 | "37000" |
| `{{totalAmountFormatted}}` | 合計金額（¥記号付き、3桁区切り、整数） | 文字列 | "¥37,000" |

**注意：**
- 見積明細は明細番号（`itemNumber`）の昇順でソートされます
- 数量や単価が`null`の場合は、空文字列または`"-"`が表示されます
- 金額は常に整数（小数点以下なし）で表示されます

### 関連情報（任意）

| プレースホルダー | 営業案件の項目 | 説明 | データ型 | 例 | 備考 |
|----------------|-------------|------|---------|-----|------|
| `{{contractNumber}}` | `contract.contractNumber` | 契約番号 | 文字列 | "C-2024-001" | 契約がある場合のみ |
| `{{contractDate}}` | `contract.contractDate` | 契約日（YYYY/MM/DD形式） | 文字列 | "2024/11/17" | 契約がある場合のみ |
| `{{projectTitle}}` | `project.title` | プロジェクトタイトル | 文字列 | "天井クレーン点検プロジェクト" | プロジェクトがある場合のみ |
| `{{projectStatus}}` | `project.status` | プロジェクトステータス（英語コード） | 文字列 | "IN_PROGRESS" | プロジェクトがある場合のみ |
| `{{projectStatusLabel}}` | `project.status` | プロジェクトステータス（日本語） | 文字列 | "進行中" | プロジェクトがある場合のみ |

## テンプレートファイルの命名規則

### 推奨命名規則

テンプレートファイルのファイル名は、以下の規則に従うことを推奨します：

#### 基本形式

```
[テンプレートタイプ]_[説明]_[バージョン].[拡張子]
```

#### 命名例

**見積書テンプレート：**
- `見積書テンプレート_標準版.xlsx`
- `見積書テンプレート_2024.xlsx`
- `見積書_簡易版_v1.xlsx`
- `quote_template_standard.xlsx`

**契約書テンプレート：**
- `契約書テンプレート_標準版.xlsx`
- `契約書_詳細版.xlsx`
- `contract_template_v1.xlsx`

**報告書テンプレート：**
- `報告書テンプレート_標準版.xlsx`
- `報告書_簡易版.xlsx`
- `report_template_standard.xlsx`

#### 命名規則のポイント

1. **テンプレートタイプを明示**
   - 見積書、契約書、報告書など、用途が分かるようにする

2. **説明を追加（任意）**
   - 標準版、簡易版、詳細版など、バリエーションを区別

3. **バージョン番号（任意）**
   - `v1`, `v2`, `2024`, `2024-11` など、バージョン管理が可能

4. **拡張子を保持**
   - `.xlsx`（Excel）または `.docx`（Word）

#### 注意事項

- **システム内での管理：** ファイル名はデータベースの`name`フィールドで管理されるため、ファイル名自体は識別用として使用されます
- **重複：** 同じファイル名でも、システム内では異なるIDで管理されるため問題ありません
- **日本語可：** 日本語のファイル名も使用可能です
- **特殊文字：** `/`, `\`, `:`, `*`, `?`, `"`, `<`, `>`, `|` などの特殊文字は避けてください

## Excelテンプレートの作成方法

### 1. Excelファイルを開く

Microsoft Excel または LibreOffice Calc で新しいファイルを作成します。

**推奨：** ファイル名は上記の命名規則に従って保存してください。

### 2. プレースホルダーを配置

見積書のフォーマットに従って、各セルにプレースホルダーを入力します。

**例：**
```
| A列          | B列                  |
|--------------|----------------------|
| 取引先名：    | {{companyName}}      |
| 郵便番号：    | {{companyPostalCode}}|
| 住所：        | {{companyAddress}}   |
| 電話番号：    | {{companyPhone}}     |
| メール：      | {{companyEmail}}     |
|              |                      |
| 案件タイトル：| {{opportunityTitle}} |
| 想定金額：    | {{estimatedAmountFormatted}} |
| クレーン台数：| {{craneCount}}台     |
| クレーン情報：| {{craneInfo}}        |
| 備考：        | {{notes}}            |
| 発生日：      | {{occurredAt}}       |
| 見積数：      | {{quoteCount}}件     |
```

### 3. セルの書式設定（任意）

必要に応じて、セルの書式設定を行います：
- 金額のセル：通貨形式（例: `¥#,##0`）
- 日付のセル：日付形式（例: `yyyy/mm/dd`）

**注意：** プレースホルダーを置換した後、書式設定は維持されます。

### 4. ファイルを保存

`.xlsx`形式で保存します。

### 5. システムにアップロード

作成したExcelテンプレートをシステムにアップロードします：

**アップロード方法：**
- 詳細は `docs/テンプレートアップロード手順.md` を参照してください
- APIエンドポイント: `/api/document-templates` (POST)
- ブラウザの開発者ツール（コンソール）からもアップロード可能
- または、後で実装するテンプレート管理画面からアップロード

## Wordテンプレートの作成方法

### 1. Wordファイルを開く

Microsoft Word で新しいファイルを作成します。

### 2. プレースホルダーを配置

見積書のフォーマットに従って、本文中にプレースホルダーを入力します。

**例：**
```
見積書

取引先名：{{companyName}}
郵便番号：{{companyPostalCode}}
住所：{{companyAddress}}
電話番号：{{companyPhone}}
メール：{{companyEmail}}

案件タイトル：{{opportunityTitle}}
ステータス：{{statusLabel}}
想定金額：{{estimatedAmountFormatted}}
クレーン台数：{{craneCount}}台
クレーン情報：{{craneInfo}}
備考：{{notes}}
発生日：{{occurredAt}}
見積数：{{quoteCount}}件

【見積情報】
見積番号：{{quoteNumber}}
見積金額：{{quoteAmountFormatted}}
ステータス：{{quoteStatusLabel}}
条件：{{quoteConditions}}
有効期限：{{quoteValidUntil}}
備考：{{quoteNotes}}
作成日：{{quoteCreatedAt}}

【見積明細】
{{#items}}
明細番号: {{itemNumber}}
明細内容: {{description}}
数量: {{quantity}}
単価: {{unitPriceFormatted}}
金額: {{amountFormatted}}
備考: {{notes}}

{{/items}}

合計金額：{{totalAmountFormatted}}
```

### 3. ファイルを保存

`.docx`形式で保存します。

### 4. システムにアップロード

作成したWordテンプレートをシステムにアップロードします。

**アップロード方法：**
- 詳細は `docs/テンプレートアップロード手順.md` を参照してください
- APIエンドポイント: `/api/document-templates` (POST)
- ブラウザの開発者ツール（コンソール）からもアップロード可能

## データの変換ルール

### 金額

- `estimatedAmount`: 数値のみ（例: `1000000`）
- `estimatedAmountFormatted`: ¥記号と3桁区切り（例: `¥1,000,000`）
- `quoteAmount`: 数値のみ、整数（例: `37000`）
- `quoteAmountFormatted`: ¥記号と3桁区切り、整数（例: `¥37,000`）
- `item1Amount`, `item2Amount`, ...: 数値のみ、整数（例: `30000`）
- `item1AmountFormatted`, `item2AmountFormatted`, ...: ¥記号と3桁区切り、整数（例: `¥30,000`）
- `totalAmount`: 数値のみ、整数（例: `37000`）
- `totalAmountFormatted`: ¥記号と3桁区切り、整数（例: `¥37,000`）

### 日付

- `occurredAt`: YYYY/MM/DD形式（例: `2024/11/17`）
- `quoteCreatedAt`: YYYY/MM/DD形式（例: `2024/11/17`）
- `quoteCreatedAtDateTime`: YYYY/MM/DD HH:MM形式（例: `2024/11/17 10:30`）
- `quoteUpdatedAt`: YYYY/MM/DD形式（例: `2024/11/17`）
- `quoteUpdatedAtDateTime`: YYYY/MM/DD HH:MM形式（例: `2024/11/17 14:20`）
- `quoteValidUntil`: YYYY/MM/DD形式（例: `2024/12/31`）

### 見積ステータス

- `quoteStatus`: 英語コード（例: `"DRAFT"`, `"SENT"`, `"ACCEPTED"`, `"REJECTED"`）
- `quoteStatusLabel`: 日本語（例: `"下書き"`, `"送信済み"`, `"承認済み"`, `"却下"`）

### NULL値の処理

- データがNULLの場合は、空文字列（`""`）に変換されます
- 数値がNULLの場合は、空文字列または`"-"`が表示されます
- 数量や単価がNULLの場合は、空文字列または`"-"`が表示されます

### 見積明細の処理

- 見積明細は明細番号（`itemNumber`）の昇順でソートされます
- 固定行数方式（方法2）を使用する場合、明細が存在しない行は空文字列が表示されます
- 明細が指定された行数（例: 10行）を超える場合、超えた分は表示されません（制限事項）

## トラブルシューティング

### プレースホルダーが置換されない

1. プレースホルダーの形式を確認（`{{変数名}}`）
2. 変数名のスペルミスを確認
3. セルの値として設定されているか確認（Excelの場合）
4. テンプレートが正しくアップロードされているか確認

### 日付や金額のフォーマットが期待通りでない

1. Excel/Wordのセル書式設定を確認
2. プレースホルダーを置換した後、書式設定を再適用

### エラーが発生する

1. テンプレートファイルが破損していないか確認
2. ファイル形式が正しいか確認（.docx または .xlsx）
3. APIエンドポイントのログを確認
