# 開発フロー

## 概要

本番環境がVercelで稼働している状態での、今後の開発・デプロイの手順を説明します。

## 基本的な開発フロー

### 1. ローカルでの開発

1. **ローカル環境で開発**
   ```bash
   # 開発サーバーを起動
   npm run dev
   ```
   - ブラウザで `http://localhost:3000` にアクセス
   - 変更内容を確認しながら開発

2. **データベースの確認**
   - ローカル環境では、`.env.local` の `DATABASE_URL` を使用
   - 本番環境のデータベースを使用する場合は、環境変数を一時的に変更（注意が必要）

3. **動作確認**
   - 機能が正常に動作することを確認
   - エラーがないことを確認
   - ブラウザのコンソールでエラーがないことを確認

### 2. テストと確認

1. **型チェック**
   ```bash
   npm run build
   ```
   - TypeScriptの型エラーがないことを確認

2. **リンター（オプション）**
   ```bash
   npm run lint
   ```
   - コードの品質を確認

3. **ローカルでの動作確認**
   - すべての機能が正常に動作することを確認
   - エッジケースも確認

### 3. Gitへのコミットとプッシュ

1. **変更内容を確認**
   ```bash
   git status
   git diff
   ```

2. **ステージング**
   ```bash
   git add [変更したファイル]
   # または
   git add .
   ```

3. **コミット**
   ```bash
   git commit -m "変更内容の説明"
   ```
   - コミットメッセージは日本語で、変更内容を明確に記述

4. **プッシュ**
   ```bash
   git push
   ```

### 4. Vercelでの自動デプロイ

1. **プレビュー環境への自動デプロイ**
   - GitHubにプッシュすると、Vercelが自動的にプレビュー環境をデプロイ
   - ブランチごとにプレビューURLが生成される
   - 例: `https://cranemanagementapp-git-[ブランチ名]-jun-matsubaras-projects.vercel.app`

2. **プレビュー環境での確認**
   - Vercelダッシュボードでデプロイ状況を確認
   - プレビューURLで動作確認
   - 問題がないことを確認

3. **本番環境へのデプロイ**
   - `main` ブランチにマージすると、自動的に本番環境にデプロイ
   - または、Vercelダッシュボードから手動で本番環境にプロモート

## ブランチ戦略（推奨）

### 基本的な流れ

1. **機能ブランチを作成**
   ```bash
   git checkout -b feature/機能名
   ```

2. **開発とコミット**
   - 機能ブランチで開発
   - 定期的にコミット

3. **プレビュー環境で確認**
   - プッシュすると自動的にプレビュー環境が作成される
   - プレビューURLで動作確認

4. **mainブランチにマージ**
   ```bash
   git checkout main
   git merge feature/機能名
   git push
   ```
   - `main` ブランチにマージすると、自動的に本番環境にデプロイ

### ブランチ命名規則

- `feature/機能名` - 新機能の開発
- `fix/バグ修正内容` - バグ修正
- `refactor/リファクタリング内容` - リファクタリング
- `docs/ドキュメント内容` - ドキュメント更新

## 環境変数の管理

### ローカル環境（`.env.local`）

```env
DATABASE_URL=postgresql://postgres:[PASSWORD]@db.xxxxx.supabase.co:5432/postgres
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=[ローカル用のシークレット]
```

### 本番環境（Vercel）

- Vercelダッシュボードの「Settings」→「Environment Variables」で管理
- 環境変数を変更した場合は、**必ず再デプロイ**が必要

**本番環境の環境変数:**
```
DATABASE_URL=postgresql://postgres.xxxxx:[PASSWORD]@aws-1-ap-south-1.pooler.supabase.com:6543/postgres?pgbouncer=true&connect_timeout=15&pool_timeout=15
NEXTAUTH_URL=https://manage.crane-mitsumori.com
NEXTAUTH_SECRET=[本番環境用のシークレット]
```

## データベースの変更

### スキーマの変更

1. **ローカルでスキーマを変更**
   ```bash
   # prisma/schema.prisma を編集
   ```

2. **マイグレーションの作成**
   ```bash
   npx prisma migrate dev --name マイグレーション名
   ```

3. **ローカルで確認**
   ```bash
   npm run dev
   ```

4. **コミットとプッシュ**
   ```bash
   git add prisma/
   git commit -m "データベーススキーマを更新"
   git push
   ```

5. **本番環境への適用**
   - Vercelでは自動的にマイグレーションは実行されません
   - 手動でマイグレーションを実行する必要があります

**本番環境でのマイグレーション実行方法:**

**方法1: ローカルから実行（推奨）**
```bash
# 本番環境のDATABASE_URLを一時的に設定
export DATABASE_URL="[本番環境のDATABASE_URL]"

# マイグレーション実行
npx prisma migrate deploy

# 環境変数を元に戻す
unset DATABASE_URL
```

**方法2: SupabaseのSQL Editorで実行**
- Supabaseダッシュボードの「SQL Editor」を開く
- `prisma/migrations` フォルダ内のSQLファイルを実行

## デプロイ前のチェックリスト

- [ ] ローカルで `npm run build` が成功する
- [ ] ローカルで動作確認が完了している
- [ ] 型エラーがない
- [ ] コミットメッセージが適切に記述されている
- [ ] 機密情報（パスワード、APIキーなど）がコードに含まれていない
- [ ] 環境変数が必要な場合は、Vercelで設定済み

## トラブルシューティング

### デプロイが失敗する場合

1. **ビルドログを確認**
   - Vercelダッシュボードの「Deployments」でビルドログを確認
   - エラーメッセージを確認

2. **よくある原因**
   - 型エラー
   - 環境変数が設定されていない
   - 依存関係の問題
   - Prismaクライアントの生成エラー

### 本番環境でエラーが発生する場合

1. **Vercelのログを確認**
   - 「Logs」タブでエラーログを確認

2. **環境変数を確認**
   - 環境変数が正しく設定されているか確認
   - 特に `DATABASE_URL` と `NEXTAUTH_URL` を確認

3. **データベース接続を確認**
   - 接続プーリング用のURLを使用しているか確認
   - パスワードが正しいか確認

## 参考リンク

- [Vercel公式ドキュメント: デプロイメント](https://vercel.com/docs/concepts/deployments)
- [Vercel公式ドキュメント: 環境変数](https://vercel.com/docs/concepts/projects/environment-variables)
- [Prisma公式ドキュメント: マイグレーション](https://www.prisma.io/docs/concepts/components/prisma-migrate)

